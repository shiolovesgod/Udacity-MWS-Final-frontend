let restaurant;var map;window.initMap=(()=>{fetchRestaurantFromURL((e,r)=>{if(e)console.error(e);else{self.map=new google.maps.Map(document.body.querySelector("#map"),{zoom:16,center:r.latlng,scrollwheel:!1}),fillBreadcrumb();let e=DBHelper.mapMarkerForRestaurant(self.restaurant,self.map);self.marker=e,initializeRestaurantPage(self.restaurant)}HTMLHelper.setMapTabOrder(self.map)}),fetchReviewsFromURL((e,r)=>{e?console.error(e):self.reviews=r})}),fetchRestaurantFromURL=(e=>{if(self.restaurant)return void e(null,self.restaurant);const r=getParameterByName("id");r?DBHelper.getDBResource((r,t)=>{Array.isArray(t)&&(t=t[0]),self.restaurant=t,t?(fillRestaurantHTML(),e(null,t)):console.error(r)},`restaurants/${r}`):(error="No restaurant id in URL",e(error,null))});var loadedFlag=!1;function cleanInput(e){return document.createTextNode(String(e))}function initializeRestaurantPage(e=self.restaurant){reviewForm.restaurant_id.value=e.id,formSubtitle.innerText=e.name,favoriteBtn.setAttribute("data-rest-id",e.id),HTMLHelper.initFavElement(favoriteBtn,e.is_favorite)}fetchReviewsFromURL=(e=>{if(self.reviews)return void e(null,self.reviews);const r=getParameterByName("id");r?DBHelper.getDBResource((r,t)=>{self.reviews=t,t?(loadedFlag||fillReviewsHTML(t),loadedFlag=!0,e(null,t)):console.error(r)},`reviews/?restaurant_id=${r}`):(error="No restaurant id in URL",e(error,null))}),fillRestaurantHTML=((e=self.restaurant)=>{document.body.querySelector(".restaurant-name").appendChild(cleanInput(e.name));const r=document.body.querySelector(".restaurant-address");if(e.address){const t=e.address.split("").reverse().join("").replace(","," >rbw<,").split("").reverse().join("");r.innerHTML=t}else r.innerText="Address not listed";if(e.photograph){const r=document.body.querySelector(".restaurant-img-wrapper"),t=HTMLHelper.generatePictureHTML(e,[[400,800],[200,400,600],[400]],["(min-width:300px)",""]);t.querySelector("img").classList.add("restaurant-img"),r.appendChild(t)}if(e.cuisine_type){document.body.querySelector(".restaurant-cuisine").appendChild(cleanInput(e.cuisine_type))}e.operating_hours&&fillRestaurantHoursHTML()}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const r=document.body.querySelector(".restaurant-hours"),t=document.createElement("tbody");for(let r in e){const n=document.createElement("tr"),a=document.createElement("th");a.setAttribute("scope","row"),a.className="hours-day",a.appendChild(cleanInput(r)),n.appendChild(a);const o=document.createElement("ul");for(let t of e[r].split(",")){const e=document.createElement("li");e.appendChild(cleanInput(t.trim())),o.appendChild(e)}const i=document.createElement("td");i.className="hours-time",i.appendChild(o),n.appendChild(i),t.appendChild(n)}r.appendChild(t)}),fillReviewsHTML=((e=self.reviews)=>{Array.isArray(e)||(e=[e]);const r=document.body.querySelector(".reviews-container"),t=document.createElement("h2");if(t.innerHTML="Reviews",r.appendChild(t),e.length<1||!e){const e=document.createElement("p");return e.innerHTML="No reviews yet!",void r.appendChild(e)}const n=document.body.querySelector(".reviews-list");e.forEach(e=>{n.appendChild(createReviewHTML(e))}),r.appendChild(n)}),createReviewHTML=(e=>{const r=document.createElement("li");r.setAttribute("id",`rNo${parseInt(e.id)}`);const t=document.createElement("h3");if(t.appendChild(cleanInput(e.name)),r.appendChild(t),e.updatedAt){const t=new Date(e.updatedAt),n=document.createElement("p"),a=`${moment(t).calendar()}`;n.appendChild(cleanInput(a)),r.appendChild(n)}const n=document.createElement("div");n.className="rating";const a=document.createElement("p");a.innerHTML=DBHelper.rating2stars(e.rating),a.className="rating-stars",a.setAttribute("aria-hidden","true"),n.append(a);const o=document.createElement("p");o.appendChild(cleanInput(`${e.rating} Stars`)),o.className="rating-text",o.setAttribute("aria-label",`User rating ${o.innerText}`),n.append(o),r.append(n);const i=document.createElement("p");return i.className="review-comments",i.classList.add("fade-ellipsis"),i.appendChild(cleanInput(e.comments)),i.setAttribute("tabindex",0),i.addEventListener("click",function(e){e.target.classList.toggle("fade-ellipsis")}),i.addEventListener("keydown",e=>{13!=e.keyCode&&32!=e.keyCode||(e.preventDefault(),event.target.classList.toggle("fade-ellipsis"))}),r.appendChild(i),r}),fillBreadcrumb=((e=self.restaurant)=>{const r=document.querySelector(".breadcrumb"),t=document.createElement("li"),n=document.createElement("a");n.appendChild(cleanInput(e.name)),n.href=`./restaurant.html?id=${parseInt(e.id)}`,n.className="current-page",n.setAttribute("aria-current","page"),t.append(n),r.appendChild(t)}),getParameterByName=((e,r)=>{r||(r=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const t=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(r);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null});const favoriteBtn=document.body.querySelector("#options__favorite");document.addEventListener("DOMContentLoaded",function(e){window.addEventListener("online",DataSync.syncWithBackend),window.addEventListener("offline",e=>{HTMLHelper.postNotification({title:"Offline",status:"info",message:"You are offline."})}),navigator.onLine&&DataSync.syncWithBackend});try{window.DBHelper&&DBHelper.DATABASE_URL}finally{}const star0=document.body.querySelector("#star0"),star1=document.body.querySelector("#star1"),reviewForm=document.body.querySelector("#form__user-review"),formSubtitle=reviewForm.querySelector(".form-subtitle"),formErrorDiv=reviewForm.querySelector(".form-error");reviewForm.onsubmit=validateReview;const formError=document.body.querySelector(".form-error");var radioFlag=!1;function validateReview(e){if(reviewForm.rating.value<1)return formError.innerText="A restaurant rating is required.",formError.classList.add("invalid"),radioFlag||(star0.disabled=!0),star1.checked=!0,star1.focus(),!1;if(!reviewForm.restaurant_id.value)return console.log("Please add the restaurant ID!"),!1;let r=form2object(reviewForm,["name","restaurant_id","comments","rating"]);return modalOverlay.click(),DBHelper.addUserReview(r,self.restaurant.name,e=>{if(console.log("Top Level Response: "),console.log(e),e.ok||e.retry){let r=document.body.querySelector(".reviews-list"),t=createReviewHTML(e.body);t.classList.add("pending"),r.prepend(t),resetReviewForm()}else formError.innerText=e.body,formError.classList.add("invalid")}),!1}function resetReviewForm(){star0.disabled=!1,star0.checked=!0,formError.innerText="",formError.classList.remove("invalid"),reviewForm.name.value="",reviewForm.comments.value=""}function form2object(e,r){let t={},n=e.elements;for(let e=0;e<n.length;e++){if(r&&r.indexOf(n[e].name)<0)continue;t[n[e].name?n[e].name:`field${e}`]=n[e].value}return t}document.body.querySelectorAll(".radio-star").forEach(e=>{e.addEventListener("click",()=>{reviewForm.rating.value>0?(formError.innerText="",radioFlag||(star0.disabled=!0),radioFlag=!0):formError.innerText="A restaurant rating is required."})});